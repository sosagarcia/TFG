{% extends "layout.html" %} {% block head %}
<link href="../static/css/calendar/core.css" rel="stylesheet" />
<link href="../static/css/calendar/daygrid.css" rel="stylesheet" />
<link href="../static/css/calendar/timegrid.css" rel="stylesheet" />
<link href="../static/css/calendar/list.css" rel="stylesheet" />

{% endblock %} {% block body %}
<div>
  <div class="row ">
    <div class="col ml-4 mt-3 fadeIn  align-self-start first shadow p-3 mb-5 bg-white rounded" id="calendar">
      <!-- Button trigger modal -->
      <button type="button" class="btn-danger" data-toggle="modal" data-target="#borradoModal">
        Borrado masivo
      </button>
    </div>
    <div class="col align-self-start">
      <div class="wrapper fadeInDown">
        <div id="formContent">
          <!-- Mensaje -->
          <div class="fadeIn first">
            {% for mensaje in mensaje %}
            <div class="card text-white bg-{{ mensaje.tipo }} mb-3 ">
              <div class="card-header">{{ mensaje.titulo }}</div>
              <div class="card-body">
                <h4 class="card-title">{{ mensaje.author }}</h4>
                <p class="card-text">{{ mensaje.mensaje }}</p>
              </div>

              {% endfor %}
            </div>
            <!-- Login Form -->
            <form action="/add_event" method="POST" id="myForm">
              <!--  <input type="text" id="login" class="fadeIn second" name="title" placeholder="Nombre del evento" /> -->
              <select name='title'>
                {{ lista | safe }}
                <select name="color">
                  <option value="" selected hidden>Seleccione un color</option>
                  <option value="#ff0000">Rojo</option>
                  <option value="#00ff00">Verde</option>
                  <option value="#ffff00">Amarillo</option>
                  <option value="#81d6fe">Azul</option>
                </select>
                <label for="login-1">
                  Seleccione Fecha de inicio
                </label> <br />
                <input type="datetime-local" id="login-1" class="fadeIn second" name="start" />

                <label for="input-2">
                  Seleccione Método de fin
                </label> <br />

                <input id="input-2" type="checkbox" data-off-active-cls="btn-warning"
                  data-on-active-cls="btn-primary" />

                <div class="d-flex justify-content-center">
                  <input type="datetime-local" id="login-2" class="fadeIn " name="end" />
                </div>

                <div id="Duration" class=" fadeIn w-50 ml-1" style=" white-space:nowrap;">
                  <label for="horas">H:</label>

                  <input type="number" id="horas" name="horas" min="0" placeholder="0">
                  <label for="minutos">M:</label>

                  <input type="number" id="minutos" name="minutos" min="0" max="59" placeholder="0"></div>
                <select id="repe">
                  <option value="0" selected hidden>¿Desea repetir el evento?</option>
                  <option value="0">Sin repetición</option>
                  <option value="1">Repetición diaria</option>
                  <option value="2">Repetición semanal</option>
                  <option value="3">Repetición mensual</option>
                </select>

                <div id="repet" class="fadeIn ml-1">
                  <div id="ShowD">
                    <label for=" dias">Límite de días:</label>
                    <input type="number" id="semanas" name="semanas" min="1" placeholder="1">
                  </div>
                  <div id="ShowS">
                    <label for="semanas">Límite de semanas:</label>
                    <input type="number" id="semanas" name="semanas" min="1" placeholder="1">
                  </div>
                  <div id="ShowM">
                    <label for="meses">Límite de meses:</label>
                    <input type="number" id="meses" name="meses" min="1">
                  </div>
                </div>

                <input type="submit" class="fadeIn fourth" value="Guardar" />
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Modal de Borrado -->
<div class="modal fade" id="borradoModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="borradoTitulo">Borrador de eventos</h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <select id="tipoBorrado">
          <option value="" selected disabled hidden>Seleccione tipo de borrado</option>
          <option value="full">Calendario entero</option>
          <option value="day">Día entero</option>
          <option value="user">Todos los eventos de un usuario</option>
          <option value="conv">Todos los eventos de un usuario en un día</option>
        </select><br />

        <div id="usrS"><select name='title' id='usuarioBorrado'>
            {{ lista | safe }} <br />
        </div>
        <div id="fchS"><input type="date" id="fechaBorrado" /></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Cancelar
        </button>
        <button type="button" id="borradoBTN" class="btn btn-danger">
          Borrar
        </button>

      </div>
    </div>
  </div>
</div>

<!-- Modal de Selección-->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tituloEvento">Editar Evento</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        ID : <input type="text" id="idEvento" name="idEvento" />
        <select name='title1' id=''>
          {{ lista | safe }} <br />
          Inicio: <input type="text" id="inicioEvento" name="inicioEvento" /> Fin:
          <input type="datetime" id="finEvento" name="finEvento" /> Color:
          <input type="color" id="colorEvento" name="colorEvento" /><br />
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Cerrar
        </button>
        <button type="button" id="btnBorrar" class="btn btn-danger">
          Borrar Evento
        </button>
        <button type="button" id="btnGuardar" class="btn btn-success">
          Guardar cambios
        </button>
      </div>


    </div>
  </div>
</div>

{% endblock %} {% block script %}

<script src="../static/js/calendar/vendorRrule.js"></script>
<script src="../static/js/calendar/core.js"></script>
<script src="../static/js/calendar/interaction.js"></script>
<script src="../static/js/calendar/moment.js"></script>
<script src="../static/js/calendar/daygrid.js"></script>
<script src="../static/js/calendar/timegrid.js"></script>
<script src="../static/js/calendar/list.js"></script>
<script src="../static/js/calendar/rrule.js"></script>
<script src="../static/js/calendar/es.js"></script>
<script src="../static/js/bootstrap-checkbox-1.5.0/dist/js/bootstrap-checkbox.js" defer></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var x = document.getElementById("Duration");
    var y = document.getElementById("login-2");
    var horas = document.getElementById("horas");
    var minutos = document.getElementById("minutos");
    x.style.display = "none";
    y.style.display = "block";
    $(":checkbox")
      .checkboxpicker({
        onLabel: "Duración",
        offLabel: "Fecha Exacta"
      })
      .on("change", function () {
        if (x.style.display === "none") {
          x.style.display = "block";
          y.style.display = "none";

        } else {
          x.style.display = "none";
          y.style.display = "block";

          horas.value = "";
          minutos.value = "";
        }
      });

    var calendarEl = document.getElementById("calendar");
    var calendar = new FullCalendar.Calendar(calendarEl, {
      locale: "es",

      plugins: ["dayGrid", "timeGrid", "list", "interaction"],
      header: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek"
      },
      //defaultDate: { url: "today" },

      navLinks: true, // can click day/week names to navigate views
      editable: false,
      eventLimit: true, // allow "more" link when too many events
      eventTimeFormat: {
        // like '14:30:00'
        hour: "2-digit",
        minute: "2-digit",

        meridiem: true
      },
      events: { url: "data" },

      eventClick: function (info, jsEvent, view) {
        //H
        $("#tituloEvento").html(info.event.title);
        // Mostrar información de evento en los inputs

        $("#finEvento").val(info.event.end);
        $("#colorEvento").val(info.event.color);
        $("#idEvento").val(info.event.id);
        $("#idUser").val(info.event.idUser);
        var event = calendar.getEventById(info.event.id);
        var end = event.end;
        var start = event.start;
        var id = info.event.id;
        $("#finEvento").val(end);
        $("#inicioEvento").val(start);

        $("#exampleModal").modal();
        $("#btnBorrar").click(function () {
          borrar(id);
        });
        /*
        var idE = info.event.id;
        document.getElementById("btnBorrar").onclick = function() {
          doWork();
        };

        function doWork() {
          // ajax the JSON to the server
          $.post("deletEvent", idE, function() {});
          // stop link reloading the page
          event.preventDefault();
        }
        */

        //$("#txtFechaI").val(typeof (info.start));
        //$("#txtHoraI").val(FechaHora[1]);

        //document.getElementById("txtFechaI").value = info.event.start
        //lert("Event: " + info.event.title);
        //alert("Coordinates: " + info.jsEvent.pageX + "," + info.jsEvent.pageY);
        //alert("View: " + info.view.type);

        // change the border color just for fun
        //info.el.style.borderColor = "red";
      }
    });
    function borrar(id) {
      var mensaje;
      var opcion = confirm("¿Está Seguro de querer eliminar el evento?");
      if (opcion == true) {
        $.post(
          "/deletEvent",
          {
            canvas_data: JSON.stringify(id)
          },
          function (err, req, resp) {
            window.location.href = "/results/" + resp["responseJSON"];
          }
        );
        window.location.href = "/calendar";
      } else {
      }
    }

    calendar.render();
  });
</script>


<script>


  window.onload = function () {

    var repe = document.getElementById("repe");
    var repeSelected;
    var showD = document.getElementById("ShowD");

    var showS = document.getElementById("ShowS");
    var showM = document.getElementById("ShowM");
    showD.style.display = "none";
    showS.style.display = "none";
    showM.style.display = "none";
    repe.addEventListener("change", function () {

      repeSelected = this.options[repe.selectedIndex];
      console.log(repeSelected.value);



      if (repeSelected.value == 0) {
        showD.style.display = "none";
        showS.style.display = "none";
        showM.style.display = "none";
      }
      if (repeSelected.value == 1) {
        showD.style.display = "block";
        showS.style.display = "none";
        showM.style.display = "none";
      }
      if (repeSelected.value == 2) {
        showD.style.display = "none";
        showS.style.display = "block";
        showM.style.display = "none";
      }
      if (repeSelected.value == 3) {
        showD.style.display = "none";
        showS.style.display = "none";
        showM.style.display = "block";
      }

    });


    var fchS = document.getElementById("fchS");
    fchS.style.display = "none";
    var usrS = document.getElementById("usrS");
    usrS.style.display = "none";
    var select = document.getElementById("tipoBorrado");
    var selectedOption;
    var usrSelected;
    document.getElementById("borradoBTN").addEventListener("click", myFunction);
    var usr = document.getElementById("usuarioBorrado");
    var obj = 0;
    var date;
    var idBorrado = 0;


    select.addEventListener("change", function () {
      selectedOption = this.options[select.selectedIndex];
      console.log(selectedOption.value);
      if (selectedOption.value == "full") {
        fchS.style.display = "none";
        usrS.style.display = "none";
      }
      if (selectedOption.value == "day") {
        fchS.style.display = "block";
        usrS.style.display = "none";
      }
      if (selectedOption.value == "user") {
        fchS.style.display = "none";
        usrS.style.display = "block";
      }
      if (selectedOption.value == "conv") {
        fchS.style.display = "block";
        usrS.style.display = "block";
      }
    });

    usr.addEventListener("change", function () {
      usrSelected = this.options[usr.selectedIndex];
      console.log("El usuario seleccionado a borrar es" + usrSelected);

    });
    function myFunction() {
      borradoItem()
      console.log("Hola " + selectedOption.value + "Fin");
    }


    function borradoItem() {

      var fch = document.getElementById("fechaBorrado");

      if (selectedOption.value == "day") {

        obj = 0;
        date = fch.value;
        idBorrado = 1;
      }
      if (selectedOption.value == "user") {

        obj = usrSelected.value;
        date = 0;
        idBorrado = 2;
      }
      if (selectedOption.value == "conv") {

        date = fch.value;
        obj = usr.value;
        idBorrado = 3;
      }
      borrado(idBorrado, date, obj);
    }
    function borrado(valor, date, obj) {
      var opcion = confirm("¿Está seguro/a de borrar lo seleccionado?");

      if (opcion == true) {
        if (valor == 0) {
          var men = confirm("Se borrará TODOS los eventos, ¿Está seguro/a de querer continuar?");
          if (men == true) {
            $.post(
              "/deletFull",
              {
                canvas_data: JSON.stringify(valor)
              },
              function (err, req, resp) {
                window.location.href = "/results/" + resp["responseJSON"];
              }
            );
          }
        }
        if (valor == 1) {
          var men = confirm("Se borrará TODOS los eventos que comiecen en el día seleccionado ¿Está seguro/a de querer continuar?");
          if (men == true) {
            $.post(
              "/deletDay",
              {
                canvas_data: JSON.stringify(date)
              },
              function (err, req, resp) {
                window.location.href = "/results/" + resp["responseJSON"];
              }
            );
          }
        }
        if (valor == 2) {
          var men = confirm("Se borrará TODOS los eventos del usuario seleccionado ¿Está seguro/a de querer continuar?");
          if (men == true) {
            $.post(
              "/deletUser",
              {

                canvas_data: JSON.stringify(obj)
              },
              function (err, req, resp) {
                window.location.href = "/results/" + resp["responseJSON"];
              }
            );
          }
        }
        if (valor == 3) {
          var men = confirm("Se borrará TODOS los eventos del usuario que empiecen en la fecha seleccionada ¿Está seguro/a de querer continuar?");
          if (men == true) {
            $.post(
              "/delet2",
              {
                canvas_data: JSON.stringify(obj),
                canvas_data_date: JSON.stringify(date)
              },
              function (err, req, resp) {
                window.location.href = "/results/" + resp["responseJSON"];
              }
            );
          }
        }

        window.location.href = "/calendar";
      } else {
      }
    }
    startTime();
  }
</script>
{% endblock %}